<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Foul Watch DEBUG</title>
    <style>
        body { background: #121212; color: #00ff88; font-family: monospace; padding: 15px; font-size: 0.8rem; }
        .log-box { background: #000; border: 1px solid #333; padding: 10px; margin-bottom: 10px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; }
        .match-header { color: white; font-weight: bold; font-size: 1rem; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px; }
        .error { color: #ff4444; }
        .warn { color: orange; }
        button { background: #333; color: white; border: none; padding: 15px; width: 100%; font-size: 1rem; margin-bottom: 20px; border-radius: 8px; }
    </style>
</head>
<body>

    <h2 style="color:white">System Diagnostic</h2>
    <button onclick="DebugApp.run()">▶ RUN DIAGNOSTIC SCAN</button>
    <div id="logs"></div>

<script>
const Config = {
    apiKey: "0f29a2f96e9dd4231cee515cc5ec52b0", 
    apiBaseUrl: "https://v3.football.api-sports.io"
};

const DebugApp = {
    logEl: document.getElementById('logs'),
    
    log(msg, type='') {
        const div = document.createElement('div');
        div.className = `log-box ${type}`;
        div.innerHTML = msg;
        this.logEl.prepend(div);
    },

    async run() {
        this.logEl.innerHTML = ''; // Clear
        this.log("1. fetching live matches...");
        
        try {
            // 1. GET ALL LIVE FIXTURES
            const res = await fetch(`${Config.apiBaseUrl}/fixtures?live=all`, { 
                headers: { "x-rapidapi-key": Config.apiKey, "x-rapidapi-host": "v3.football.api-sports.io" }
            });
            const json = await res.json();
            
            if(!json.response || json.response.length === 0) {
                return this.log("API returned 0 live matches.", 'error');
            }

            this.log(`2. Found ${json.response.length} live matches globaly.`);

            // 2. CHECK SPECIFIC MATCHES (Limit to 5 to save bandwidth)
            const matches = json.response.slice(0, 5); 
            
            for (const m of matches) {
                await this.analyzeMatch(m);
            }

        } catch (e) {
            this.log(`CRITICAL ERROR: ${e.message}`, 'error');
        }
    },

    async analyzeMatch(m) {
        const id = m.fixture.id;
        const name = `${m.teams.home.name} vs ${m.teams.away.name}`;
        const league = m.league.name;
        
        this.log(`Analyzing: ${name} (${league})...`);

        try {
            const res = await fetch(`${Config.apiBaseUrl}/fixtures?id=${id}`, { 
                headers: { "x-rapidapi-key": Config.apiKey, "x-rapidapi-host": "v3.football.api-sports.io" }
            });
            const json = await res.json();
            const data = json.response[0];

            // CHECK 1: PLAYERS ARRAY
            if (!data.players || data.players.length === 0) {
                this.log(`❌ NO PLAYER STATS available for ${name}. \n(The API is tracking score, but not individual fouls for this league)`, 'error');
                return;
            }

            // CHECK 2: STATS DATA
            const homePlayers = data.players[0].players;
            let foulCount = 0;
            let nullCount = 0;

            homePlayers.forEach(p => {
                if(p.statistics[0].fouls.committed > 0) foulCount++;
                if(p.statistics[0].fouls.committed === null) nullCount++;
            });

            if (foulCount === 0 && nullCount > 0) {
                this.log(`⚠️ ${name}: Players found, but ALL foul stats are NULL. \n(League may not support live foul tracking)`, 'warn');
            } else {
                this.log(`✅ ${name}: OK! Found ${foulCount} players with fouls.`);
                // Print one example player
                const ex = homePlayers.find(p => p.statistics[0].fouls.committed > 0);
                if(ex) this.log(`Example: ${ex.player.name} has ${ex.statistics[0].fouls.committed} fouls.`);
            }

        } catch (e) {
            this.log(`Error reading match ${name}: ${e.message}`, 'error');
        }
    }
};
</script>
</body>
</html>
