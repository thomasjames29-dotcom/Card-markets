<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Foul Watch Scanner</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #00ff88; --danger: #ff4444; --placed: #006633; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 80px;}
        
        /* Navigation */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .h1 { margin: 0; font-size: 1.2rem; color: var(--accent); font-weight: bold; }

        /* Views */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Scanner Button */
        .scanner-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: black; border: none; padding: 20px; width: 100%;
            border-radius: 12px; font-size: 1.2rem; font-weight: bold;
            margin-bottom: 30px; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
            display: flex; justify-content: space-between; align-items: center;
        }
        .scanner-btn:active { transform: scale(0.98); }

        /* Grid & Cards */
        .grid { display: grid; gap: 10px; }
        
        /* Player Card */
        .player-card { background: var(--card); padding: 15px; border-radius: 8px; border-left: 5px solid #555; position: relative; margin-bottom: 10px; transition: all 0.3s ease; }
        .player-card.new-alert { animation: flash 2s infinite; border-left-color: var(--danger); }
        
        /* BET PLACED STATE */
        .player-card.bet-placed { 
            background: #0d2b1a; /* Dark Green bg */
            border-left-color: #00ff88 !important; 
            opacity: 0.7;
        }
        
        @keyframes flash { 0% { background: var(--card); } 50% { background: #3a1a1a; } 100% { background: var(--card); } }

        .stat-big { font-size: 1.8rem; font-weight: bold; color: var(--accent); line-height: 1; }
        .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; }
        
        .team-name { font-size: 0.9rem; color: #fff; font-weight: bold; margin-bottom: 2px;}
        .match-tag { font-size: 0.75rem; color: #aaa; display: block; }
        .cup-badge { background: #5e35b1; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.65rem; margin-left: 5px; vertical-align: middle;}
        
        /* Bet Checkbox Button */
        .bet-toggle {
            margin-top: 15px; width: 100%; padding: 8px; border-radius: 6px;
            border: 1px solid #444; background: transparent; color: #aaa;
            cursor: pointer; font-weight: bold; font-size: 0.8rem;
        }
        .bet-placed .bet-toggle {
            background: #00ff88; color: black; border-color: #00ff88;
        }

        /* Loading / Status */
        .status-bar { text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 15px; }
        .scanning-dots::after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ' ....'; } }

        /* Floating Stop Button */
        .fab { position: fixed; bottom: 20px; right: 20px; background: var(--danger); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: none; z-index: 100; cursor: pointer;}
    </style>
</head>
<body>

    <div class="header">
        <span class="h1">Foul Watch Scanner</span>
        <div id="clock" style="font-size:0.9rem; color:#666;">--:--</div>
    </div>

    <div id="view-home" class="view-section active">
        
        <button class="scanner-btn" onclick="App.startScanner()">
            <span>Start Live Scanner</span>
            <span>üì°</span>
        </button>
        
        <div style="background:#222; padding:15px; border-radius:8px; color:#aaa; font-size:0.9rem; line-height:1.6;">
            <strong>Scanner Rules:</strong><br>
            ‚Ä¢ Monitors Leagues + Scotland + Cups.<br>
            ‚Ä¢ Only matches <strong>60+ minutes</strong> in.<br>
            ‚Ä¢ Only players with <strong>2+ fouls</strong>.<br>
            ‚Ä¢ üîä Plays sound on new alerts.<br>
            ‚Ä¢ ‚úÖ Mark bets as placed to avoid dupes.
        </div>
        
        <div style="margin-top:20px; text-align:center;">
            <button onclick="localStorage.removeItem('placedBets'); alert('Bet history cleared');" style="background:#333; color:white; border:none; padding:10px; border-radius:6px;">Clear Bet History üóëÔ∏è</button>
        </div>

    </div>

    <div id="view-scanner" class="view-section">
        <div id="scanStatus" class="status-bar">Initializing...</div>
        
        <div id="scannerGrid" class="grid"></div>
        
        <div id="emptyState" style="display:none; text-align:center; color:#555; padding:40px;">
            Scanning live games...<br>No players fit the criteria yet.
        </div>

        <button class="fab" onclick="App.stopScanner()">STOP</button>
    </div>

<script>
/* --- CONFIGURATION --- */
const Config = {
    apiKey: "0f29a2f96e9dd4231cee515cc5ec52b0", 
    apiBaseUrl: "https://v3.football.api-sports.io",
    // EXPANDED LEAGUE & CUP IDs
    leagues: [
        179, 180, 183, 184, // Scotland
        39, 40, 45, 48,     // England
        140, 143,           // Spain
        135, 137,           // Italy
        78, 81,             // Germany
        61, 66,             // France
        88, 90,             // Netherlands
        253, 188,           // USA, Aus
        2, 3, 848           // Europe Cups
    ],
    minTime: 60, 
    minFouls: 2
};

/* --- AUDIO ENGINE --- */
const AudioAlert = {
    ctx: null,
    init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    playBeep() {
        if (!this.ctx) this.init();
        if (this.ctx.state === 'suspended') this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.ctx.destination);
        osc.type = 'sine'; osc.frequency.setValueAtTime(880, this.ctx.currentTime); 
        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
        osc.start(); osc.stop(this.ctx.currentTime + 0.2); 
    }
};

/* --- DATA LAYER --- */
const Data = {
    headers: { "x-rapidapi-key": Config.apiKey, "x-rapidapi-host": "v3.football.api-sports.io" },
    async getLiveFixtures() {
        try {
            const response = await fetch(`${Config.apiBaseUrl}/fixtures?live=all`, { headers: this.headers });
            const json = await response.json();
            return json.response; 
        } catch (e) { console.error(e); return []; }
    },
    async getMatchStats(fixtureId) {
        try {
            const response = await fetch(`${Config.apiBaseUrl}/fixtures?id=${fixtureId}`, { headers: this.headers });
            const json = await response.json();
            return json.response[0];
        } catch (e) { console.error(e); return null; }
    }
};

/* --- SCANNER ENGINE --- */
const App = {
    state: { 
        isScanning: false, 
        trackedPlayers: new Set(),
        matchesToScan: []
    },
    timer: null,

    /* --- CONTROLS --- */
    startScanner() {
        AudioAlert.init();
        this.state.isScanning = true;
        document.getElementById('view-home').classList.remove('active');
        document.getElementById('view-scanner').classList.add('active');
        this.runScanCycle();
        this.timer = setInterval(() => this.runScanCycle(), 60000);
    },

    stopScanner() {
        this.state.isScanning = false;
        clearInterval(this.timer);
        document.getElementById('view-scanner').classList.remove('active');
        document.getElementById('view-home').classList.add('active');
    },

    /* --- BET TRACKING (LOCAL STORAGE) --- */
    isBetPlaced(playerId) {
        const bets = JSON.parse(localStorage.getItem('placedBets') || '[]');
        return bets.includes(playerId);
    },

    toggleBet(playerId) {
        let bets = JSON.parse(localStorage.getItem('placedBets') || '[]');
        if (bets.includes(playerId)) {
            bets = bets.filter(id => id !== playerId); // Uncheck
        } else {
            bets.push(playerId); // Check
        }
        localStorage.setItem('placedBets', JSON.stringify(bets));
        
        // Immediate UI Update without re-fetch
        this.refreshBetUI(playerId);
    },

    refreshBetUI(playerId) {
        const card = document.getElementById(`card-${playerId}`);
        const btn = document.getElementById(`btn-${playerId}`);
        if(card && btn) {
            const isPlaced = this.isBetPlaced(playerId);
            if(isPlaced) {
                card.classList.add('bet-placed');
                btn.innerText = "‚úÖ BET PLACED";
            } else {
                card.classList.remove('bet-placed');
                btn.innerText = "Mark as Placed";
            }
        }
    },

    /* --- MAIN LOGIC CYCLE --- */
    async runScanCycle() {
        if (!this.state.isScanning) return;
        this.updateStatus("Scanning for active matches...");

        const allLive = await Data.getLiveFixtures();
        const relevantMatches = allLive.filter(m => {
            return Config.leagues.includes(m.league.id) && (m.fixture.status.elapsed || 0) >= Config.minTime;
        });

        if (relevantMatches.length === 0) {
            this.updateStatus(`No matches over ${Config.minTime}' found.`);
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('scannerGrid').innerHTML = '';
            return;
        }

        this.updateStatus(`Analyzing ${relevantMatches.length} active matches...`);
        document.getElementById('emptyState').style.display = 'none';

        let globalRiskyPlayers = [];
        let newAlertFound = false;
        const matchPromises = relevantMatches.map(m => Data.getMatchStats(m.fixture.id));
        const matchDetails = await Promise.all(matchPromises);

        matchDetails.forEach(match => {
            if (!match) return;
            const time = match.fixture.status.elapsed;
            const leagueName = match.league.name;
            const isCup = leagueName.toLowerCase().includes('cup') || leagueName.toLowerCase().includes('pokal') || leagueName.toLowerCase().includes('rey');
            
            const subbedOffIds = new Set();
            if(match.events) {
                match.events.forEach(e => { if(e.type === "subst") subbedOffIds.add(e.player.id); });
            }

            const allPlayers = [...match.players[0].players, ...match.players[1].players];

            allPlayers.forEach(p => {
                const stats = p.statistics[0];
                const fouls = stats.fouls.committed || 0;
                
                if (fouls >= Config.minFouls && !subbedOffIds.has(p.player.id)) {
                    const pId = p.player.id;
                    if (!this.state.trackedPlayers.has(pId)) {
                        this.state.trackedPlayers.add(pId);
                        newAlertFound = true;
                        p.isNew = true;
                    }

                    globalRiskyPlayers.push({
                        id: pId,
                        name: p.player.name,
                        team: stats.team.name, // TEAM NAME ADDED HERE
                        match: `${match.teams.home.name} v ${match.teams.away.name}`,
                        league: leagueName,
                        isCup: isCup,
                        time: time,
                        fouls: fouls,
                        tackles: stats.tackles.total || 0,
                        booked: stats.cards.yellow > 0,
                        isNew: p.isNew
                    });
                }
            });
        });

        globalRiskyPlayers.sort((a, b) => b.fouls - a.fouls);
        if (newAlertFound) AudioAlert.playBeep();
        this.renderList(globalRiskyPlayers);
        this.updateStatus(`Scanning Active. Found ${globalRiskyPlayers.length} targets.`);
    },

    /* --- RENDERING --- */
    renderList(players) {
        const grid = document.getElementById('scannerGrid');
        if (players.length === 0) {
            document.getElementById('emptyState').style.display = 'block';
            grid.innerHTML = '';
            return;
        }

        grid.innerHTML = players.map(p => {
            const isPlaced = this.isBetPlaced(p.id);
            return `
            <div id="card-${p.id}" class="player-card ${p.isNew ? 'new-alert' : ''} ${isPlaced ? 'bet-placed' : ''}" style="border-left-color:${p.booked ? 'yellow' : '#ff4444'}">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <div class="team-name">${p.name} (${p.team})</div>
                        ${p.isCup ? '<span class="cup-badge">CUP</span>' : ''}
                        <span class="match-tag">${p.match}</span>
                        <span class="match-tag" style="color:#666">${p.time}' | ${p.league}</span>
                    </div>
                    <div style="text-align:center;">
                        <div class="stat-big">${p.fouls}</div>
                        <div class="stat-label">Fouls</div>
                    </div>
                </div>
                
                <div style="margin-top:10px; display:flex; gap:10px; font-size:0.8rem; color:#aaa;">
                    <span>Tackles: <b style="color:white">${p.tackles}</b></span>
                    <span>${p.booked ? 'üü® Carded' : '‚ö†Ô∏è No Card'}</span>
                </div>

                <button id="btn-${p.id}" class="bet-toggle" onclick="App.toggleBet(${p.id})">
                    ${isPlaced ? '‚úÖ BET PLACED' : 'Mark as Placed'}
                </button>
            </div>
        `}).join('');
    },

    updateStatus(msg) {
        const el = document.getElementById('scanStatus');
        el.innerText = msg;
        el.classList.add('scanning-dots');
    }
};

setInterval(() => {
    document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}, 1000);

</script>
</body>
</html>
