<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Safe Debugger</title>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: monospace; padding: 15px; font-size: 0.85rem; }
        .header { border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; font-size: 1.1rem; color: #00ff88; }
        .btn { background: #00ff88; color: black; border: none; padding: 15px; width: 100%; font-weight: bold; font-size: 1rem; border-radius: 8px; margin-bottom: 20px; cursor: pointer; }
        
        .card { background: #1e1e1e; padding: 10px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #555; }
        .card.visible { border-left-color: #00ff88; background: #0d2b1a; }
        .card.hidden { border-left-color: #ff4444; }
        
        .reason { color: #ff4444; font-weight: bold; margin-top: 5px; }
        .success { color: #00ff88; font-weight: bold; margin-top: 5px; }
        .meta { color: #888; margin-bottom: 4px; font-size: 0.75rem; }
        .raw-id { background: #333; color: white; padding: 2px 4px; border-radius: 3px; font-size: 0.7rem; }
    </style>
</head>
<body>

    <div class="header">üõ°Ô∏è SAFE DEBUGGER</div>
    
    <button class="btn" onclick="Debug.run()">START SEQUENTIAL SCAN</button>
    
    <div id="results"></div>

<script>
const Config = {
    apiKey: "0f29a2f96e9dd4231cee515cc5ec52b0", 
    apiBaseUrl: "https://v3.football.api-sports.io",
    // Your exact league list
    leagues: [179,180,183,184, 39,40,45,48, 140,143, 135,137, 78,81, 61,66, 88,90, 253,188, 2,3,848],
    minTime: 60,
    minFouls: 2
};

const Debug = {
    el: document.getElementById('results'),
    
    log(html) { this.el.innerHTML += html; },

    async run() {
        this.el.innerHTML = '<div style="text-align:center">1. Connecting to API...</div>';
        
        try {
            // 1. Fetch List
            const res = await fetch(`${Config.apiBaseUrl}/fixtures?live=all`, { 
                headers: { "x-rapidapi-key": Config.apiKey, "x-rapidapi-host": "v3.football.api-sports.io" }
            });
            const json = await res.json();
            const matches = json.response;

            if(!matches || matches.length === 0) {
                this.el.innerHTML = "API returned 0 live matches.";
                return;
            }

            this.el.innerHTML = `<div>Found ${matches.length} live matches. <br>Scanning one-by-one to prevent crash...</div><br>`;

            // 2. Process Sequentially (One at a time)
            // We prioritize matches that look like they might be the ones we want
            matches.sort((a,b) => {
                // Priority to Italy (Serie A) or similar
                const isPriorityA = Config.leagues.includes(a.league.id);
                const isPriorityB = Config.leagues.includes(b.league.id);
                return isPriorityB - isPriorityA;
            });

            for (const m of matches) {
                await this.analyzeMatch(m);
            }

        } catch (e) {
            this.log(`<div style="color:red; margin-top:20px;">CRITICAL ERROR: ${e.message}</div>`);
        }
    },

    async analyzeMatch(m) {
        const id = m.fixture.id;
        const name = `${m.teams.home.name} v ${m.teams.away.name}`;
        
        // Skip match if we already know the league isn't in our list (save time)
        // BUT for debugging, let's process it anyway to see the ID
        
        try {
            const r = await fetch(`${Config.apiBaseUrl}/fixtures?id=${id}`, { 
                headers: { "x-rapidapi-key": Config.apiKey, "x-rapidapi-host": "v3.football.api-sports.io" }
            });
            const j = await r.json();
            const game = j.response[0];

            if(!game) return;

            const leagueId = game.league.id;
            const leagueName = game.league.name;
            const time = game.fixture.status.elapsed;

            // DATA CHECK
            let maxFouls = 0;
            let playerWithMax = "None";
            
            if(game.players && game.players.length > 0) {
                const players = [...game.players[0].players, ...game.players[1].players];
                players.forEach(p => {
                    const f = p.statistics[0].fouls.committed || 0;
                    if(f > maxFouls) { maxFouls = f; playerWithMax = p.player.name; }
                });
            } else {
                maxFouls = -1; // No Data
            }

            // FILTER LOGIC
            let status = "VISIBLE ‚úÖ";
            let reason = "";
            let css = "visible";

            if (!Config.leagues.includes(leagueId)) {
                status = "HIDDEN ‚ùå";
                reason = `League ID ${leagueId} not in list.`;
                css = "hidden";
            }
            else if (time < Config.minTime) {
                status = "HIDDEN ‚ùå";
                reason = `Time is ${time}' (Need ${Config.minTime}').`;
                css = "hidden";
            }
            else if (maxFouls === -1) {
                status = "HIDDEN ‚ùå";
                reason = "No foul data available.";
                css = "hidden";
            }
            else if (maxFouls < Config.minFouls) {
                status = "HIDDEN ‚ùå";
                reason = `Highest foul count is ${maxFouls} (Need ${Config.minFouls}).`;
                css = "hidden";
            } else {
                reason = `Target: ${playerWithMax} (${maxFouls} fouls)`;
            }

            // Print Card
            const html = `
            <div class="card ${css}">
                <div style="font-size:1rem; font-weight:bold; color:white;">${name}</div>
                <div class="meta">${leagueName} | <span class="raw-id">ID: ${leagueId}</span> | Time: ${time}'</div>
                <div class="${css === 'visible' ? 'success' : 'reason'}">${status} <br>${reason}</div>
            </div>`;

            this.log(html);

        } catch (e) {
            console.error(e);
            this.log(`<div style="color:orange; font-size:0.7rem;">Skipped ${name} (Network Error)</div>`);
        }
    }
};
</script>
</body>
</html>
