<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Foul Watch: UNFILTERED</title>
    <style>
        :root { --bg: #000000; --card: #1a1a1a; --text: #ffffff; --accent: #00ff88; --danger: #ff3333; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 80px; }
        
        .header { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .h1 { color: var(--accent); font-weight: 900; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }

        .control-panel { background: #111; padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; }
        .status-text { color: #888; font-size: 0.9rem; margin-top: 10px; font-family: monospace; }
        
        .btn { background: var(--accent); color: black; border: none; padding: 15px; width: 100%; font-weight: bold; font-size: 1rem; border-radius: 8px; cursor: pointer; }
        .btn.stop { background: var(--danger); color: white; margin-top: 10px; }

        /* MATCH CONTAINER */
        .match-group { margin-bottom: 20px; border: 1px solid #333; border-radius: 8px; overflow: hidden; background: #0a0a0a; }
        .match-header { 
            background: #222; padding: 10px 15px; font-weight: bold; font-size: 0.95rem; 
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333;
        }
        .match-meta { font-size: 0.75rem; color: #888; margin-top: 2px; }
        .match-score { color: var(--accent); font-family: monospace; font-size: 1.1rem; }

        /* PLAYER ROW */
        .player-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 15px; border-bottom: 1px solid #1a1a1a; background: var(--card);
        }
        .player-row:last-child { border-bottom: none; }
        .p-name { font-weight: 600; font-size: 0.9rem; }
        .p-team { font-size: 0.75rem; color: #888; }
        .p-stat { text-align: right; }
        .foul-count { color: var(--accent); font-weight: bold; font-size: 1.1rem; }
        .card-icon { font-size: 0.8rem; margin-left: 5px; }

        .loading-bar { height: 4px; background: #333; width: 100%; margin-top: 15px; border-radius: 2px; overflow: hidden; }
        .loading-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

    <div class="header">
        <div class="h1">Foul Watch: RAW</div>
        <div id="clock" style="color:#666; font-size:0.8rem">--:--</div>
    </div>

    <div class="control-panel">
        <button id="scanBtn" class="btn" onclick="App.start()">START GLOBAL SCAN</button>
        <div class="loading-bar"><div id="progress" class="loading-fill"></div></div>
        <div id="status" class="status-text">Ready to scan.</div>
    </div>

    <div id="results"></div>

<script>
const Config = {
    apiKey: "0f29a2f96e9dd4231cee515cc5ec52b0", 
    baseUrl: "https://v3.football.api-sports.io"
};

const App = {
    scanning: false,
    
    async start() {
        if(this.scanning) return;
        this.scanning = true;
        
        const btn = document.getElementById('scanBtn');
        btn.innerText = "STOP SCAN";
        btn.classList.add('stop');
        btn.onclick = () => this.stop();
        
        document.getElementById('results').innerHTML = '';
        this.status("Fetching ALL live matches...");
        
        try {
            // 1. Get List of ALL live games (No League Filter)
            const res = await fetch(`${Config.baseUrl}/fixtures?live=all`, {
                headers: { "x-rapidapi-key": Config.apiKey, "x-rapidapi-host": "v3.football.api-sports.io" }
            });
            const json = await res.json();
            const matches = json.response || [];

            if(matches.length === 0) {
                this.status("No live matches found globally.");
                this.stop();
                return;
            }

            this.status(`Found ${matches.length} live matches. Analyzing stats...`);

            // 2. Sort to prioritize big leagues (optional, but helps UX)
            // We just sort alphabetically by league for cleanliness
            matches.sort((a,b) => a.league.name.localeCompare(b.league.name));

            // 3. Process One-by-One
            await this.processQueue(matches);

        } catch(e) {
            this.status("Error: " + e.message);
            this.stop();
        }
    },

    stop() {
        this.scanning = false;
        const btn = document.getElementById('scanBtn');
        btn.innerText = "START GLOBAL SCAN";
        btn.classList.remove('stop');
        btn.onclick = () => this.start();
        this.status("Scan stopped.");
        document.getElementById('progress').style.width = '0%';
    },

    async processQueue(matches) {
        const total = matches.length;
        
        for(let i=0; i<total; i++) {
            if(!this.scanning) break;
            
            const m = matches[i];
            const pct = ((i+1) / total) * 100;
            document.getElementById('progress').style.width = `${pct}%`;
            this.status(`Checking ${i+1}/${total}: ${m.teams.home.name} (${m.league.name})`);

            try {
                // Fetch Stats
                const res = await fetch(`${Config.baseUrl}/fixtures?id=${m.fixture.id}`, {
                    headers: { "x-rapidapi-key": Config.apiKey, "x-rapidapi-host": "v3.football.api-sports.io" }
                });
                const json = await res.json();
                const game = json.response[0];

                if(game) {
                    this.renderMatchIfHasData(game);
                }

            } catch(e) {
                console.error(e); // Silent fail on individual match to keep queue moving
            }
        }
        
        this.status("Scan Complete. Restarting in 10s...");
        setTimeout(() => { if(this.scanning) this.start(); }, 10000);
    },

    renderMatchIfHasData(game) {
        // Extract players with > 0 fouls
        let foulers = [];
        
        const players = [];
        if(game.players && game.players[0]) players.push(...game.players[0].players);
        if(game.players && game.players[1]) players.push(...game.players[1].players);

        players.forEach(p => {
            const stats = p.statistics[0];
            const fouls = stats.fouls.committed || 0;
            
            // SHOW ANYONE WITH 1+ FOUL
            if(fouls > 0) {
                foulers.push({
                    name: p.player.name,
                    team: stats.team.name,
                    fouls: fouls,
                    card: stats.cards.yellow > 0 ? 'ðŸŸ¨' : (stats.cards.red > 0 ? 'ðŸŸ¥' : '')
                });
            }
        });

        // If nobody has fouled, we skip rendering this match to keep screen clean
        if(foulers.length === 0) return;

        // Sort foulers high to low
        foulers.sort((a,b) => b.fouls - a.fouls);

        // CREATE HTML
        const container = document.getElementById('results');
        const matchDiv = document.createElement('div');
        matchDiv.className = 'match-group';
        
        const elapsed = game.fixture.status.elapsed;
        const league = game.league.name;
        
        let playersHtml = foulers.map(p => `
            <div class="player-row">
                <div>
                    <div class="p-name">${p.name} <span class="card-icon">${p.card}</span></div>
                    <div class="p-team">${p.team}</div>
                </div>
                <div class="p-stat">
                    <div class="foul-count">${p.fouls}</div>
                </div>
            </div>
        `).join('');

        matchDiv.innerHTML = `
            <div class="match-header">
                <div>
                    ${game.teams.home.name} v ${game.teams.away.name}
                    <div class="match-meta">${league} | ${elapsed}'</div>
                </div>
                <div class="match-score">${game.goals.home}-${game.goals.away}</div>
            </div>
            ${playersHtml}
        `;

        // Prepend so newest scans appear at top, or append? Let's append.
        container.appendChild(matchDiv);
    },

    status(msg) { document.getElementById('status').innerText = msg; }
};

setInterval(() => {
    document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}, 1000);
</script>
</body>
</html>
