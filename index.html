<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Foul Watch Live</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #00ff88; --danger: #ff4444; --warn: #ffbb00; --sub: #555; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 80px;}
        
        /* Navigation */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .h1 { margin: 0; font-size: 1.2rem; color: var(--accent); cursor: pointer; }
        .back-btn { background: #333; border: none; color: white; padding: 5px 12px; border-radius: 4px; font-size: 0.8rem; display: none; }

        /* Views */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Grid & Cards */
        .grid { display: grid; gap: 10px; }
        
        /* Selection Buttons */
        .league-btn, .match-card { 
            background: var(--card); border: 1px solid #333; color: white; 
            padding: 15px; border-radius: 10px; cursor: pointer;
        }
        .match-card { display: flex; justify-content: space-between; align-items: center; }
        .match-time { font-size: 0.8rem; color: #888; }
        
        /* LIVE MONITOR STYLES */
        .live-badge { background: red; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .player-card { background: var(--card); padding: 15px; border-radius: 8px; border-left: 5px solid #555; position: relative; }
        
        /* Subbed Off Styling */
        .player-card.subbed { opacity: 0.6; filter: grayscale(0.8); border-left-color: #555 !important; }
        .sub-badge { background: var(--danger); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-left: 5px; }

        .stat-big { font-size: 1.8rem; font-weight: bold; color: var(--accent); line-height: 1; }
        .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; }
        
        /* Floating Action Button */
        .fab { position: fixed; bottom: 20px; right: 20px; background: var(--accent); color: black; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: none; z-index: 100; cursor: pointer;}
    </style>
</head>
<body>

    <div class="header">
        <div>
            <button id="backBtn" class="back-btn" onclick="App.goBack()">← Back</button>
            <span class="h1" onclick="App.goHome()">Foul Watch</span>
        </div>
        <div id="statusIndicator" style="font-size:0.8rem; color:#666;">Ready</div>
    </div>

    <div id="view-leagues" class="view-section active">
        <h3 style="color:#888; margin-top:0;">Select Competition</h3>
        <div id="leagueGrid" class="grid"></div>
    </div>

    <div id="view-matches" class="view-section">
        <h3 id="leagueTitle" style="color:#888; margin-top:0;">Matches</h3>
        <div id="matchGrid" class="grid"></div>
        <p id="noMatchesMsg" style="display:none; text-align:center; color:#666">No matches today.</p>
    </div>

    <div id="view-analysis" class="view-section">
        <div id="matchHeader" style="text-align:center; margin-bottom:15px; font-size:0.9rem; color:#aaa;"></div>
        
        <div style="background:#222; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.8rem; color:#888; display:flex; align-items:center; gap:10px;">
            <span>ℹ️ Showing players with 2+ fouls only</span>
        </div>

        <div id="playerGrid" class="grid"></div>
        <div id="emptyState" style="display:none; text-align:center; color:#555; padding:40px;">
            No players have reached 2 fouls yet.
        </div>
    </div>

    <button class="fab" onclick="App.refreshCurrentView()">↻</button>

<script>
/* --- CONFIGURATION --- */
const Config = {
    apiKey: "0f29a2f96e9dd4231cee515cc5ec52b0", 
    apiBaseUrl: "https://v3.football.api-sports.io",
    leagues: [
        { name: "Premier League", id: 39 }, { name: "Championship", id: 40 },
        { name: "La Liga", id: 140 }, { name: "Serie A", id: 135 },
        { name: "Bundesliga", id: 78 }, { name: "Ligue 1", id: 61 },
        { name: "Eredivisie", id: 88 }, { name: "MLS", id: 253 },
        { name: "A-League", id: 188 }
    ],
    weights: {
        basePosition: 10, foul: 20, tackle: 3, gameTime: 0.5
    }
};

/* --- DATA LAYER --- */
const Data = {
    headers: { "x-rapidapi-key": Config.apiKey, "x-rapidapi-host": "v3.football.api-sports.io" },

    async fetchAPI(endpoint) {
        try {
            const res = await fetch(`${Config.apiBaseUrl}${endpoint}`, { headers: this.headers });
            const json = await res.json();
            return json.response;
        } catch (e) { console.error(e); return []; }
    },

    async getMatches(leagueId) {
        const today = new Date().toISOString().split('T')[0];
        // Season hardcoded to 2025 (Europe/Current)
        return await this.fetchAPI(`/fixtures?league=${leagueId}&season=2025&date=${today}`);
    },

    async getMatchDetails(matchId) {
        const data = await this.fetchAPI(`/fixtures?id=${matchId}`);
        return data[0];
    }
};

/* --- PREDICTOR ENGINE --- */
const Predictor = {
    calculateConfidence(player, elapsedTime) {
        let stats = player.statistics[0];
        let score = 0;

        const fouls = stats.fouls.committed || 0;
        const tackles = stats.tackles.total || 0;
        
        // Heavy weighting on fouls since we are filtering by 2+
        score += (fouls * Config.weights.foul); 
        score += (tackles * Config.weights.tackle);

        const pos = stats.games.position;
        if (pos === 'Defender' || pos === 'Midfielder') score += Config.weights.basePosition;

        if (elapsedTime > 50) score += ((elapsedTime - 50) * Config.weights.gameTime);

        if (stats.cards.yellow > 0) return 100; // Booked

        return Math.min(Math.floor(score), 99);
    },

    getRiskColor(score) {
        if(score >= 80) return '#ff4444'; // Red
        if(score >= 50) return '#ffbb00'; // Orange
        return '#00c853'; // Green
    }
};

/* --- UI CONTROLLER --- */
const App = {
    state: { view: 'leagues', selectedLeague: null, activeMatchId: null },

    init() {
        this.renderLeagues();
        setInterval(() => {
            if (this.state.view === 'analysis' && this.state.activeMatchId) {
                this.refreshCurrentView();
            }
        }, 60000); 
    },

    /* Navigation */
    setView(view) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active');
        this.state.view = view;
        document.getElementById('backBtn').style.display = (view === 'leagues') ? 'none' : 'block';
    },

    goBack() {
        if (this.state.view === 'analysis') this.setView('matches');
        else if (this.state.view === 'matches') this.setView('leagues');
    },

    goHome() { this.setView('leagues'); },

    /* Rendering */
    renderLeagues() {
        const grid = document.getElementById('leagueGrid');
        grid.innerHTML = Config.leagues.map(l => `
            <div class="league-btn" onclick="App.loadMatches(${l.id}, '${l.name}')">
                <b>${l.name}</b>
            </div>
        `).join('');
    },

    async loadMatches(leagueId, name) {
        document.getElementById('leagueTitle').innerText = name;
        document.getElementById('matchGrid').innerHTML = 'Loading...';
        this.setView('matches');
        
        const matches = await Data.getMatches(leagueId);
        const grid = document.getElementById('matchGrid');
        grid.innerHTML = '';

        if(matches.length === 0) {
            document.getElementById('noMatchesMsg').style.display = 'block';
        } else {
            document.getElementById('noMatchesMsg').style.display = 'none';
            matches.forEach(m => {
                const isLive = ['1H','2H','ET'].includes(m.fixture.status.short);
                const time = new Date(m.fixture.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                
                grid.innerHTML += `
                    <div class="match-card" onclick="App.loadAnalysis(${m.fixture.id})">
                        <div>
                            <div style="font-weight:bold">${m.teams.home.name} <span style="color:var(--accent)">vs</span> ${m.teams.away.name}</div>
                            <div class="match-time">${time}</div>
                        </div>
                        ${isLive ? '<div class="live-badge">LIVE</div>' : ''}
                    </div>
                `;
            });
        }
    },

    async refreshCurrentView() {
        if(this.state.view !== 'analysis') return;
        const indicator = document.getElementById('statusIndicator');
        indicator.innerText = "Updating...";
        
        const data = await Data.getMatchDetails(this.state.activeMatchId);
        if(!data) return;

        // 1. Match Header
        const time = data.fixture.status.elapsed || 0;
        document.getElementById('matchHeader').innerHTML = `
            <h2>${data.teams.home.name} ${data.goals.home} - ${data.goals.away} ${data.teams.away.name}</h2>
            <span style="background:#333; padding:4px 8px; border-radius:4px;">${data.fixture.status.short} : ${time}'</span>
        `;

        // 2. Identify Subbed Players
        // We look at the 'events' array for type: "subst"
        const subbedOffIds = new Set();
        if(data.events) {
            data.events.forEach(e => {
                if(e.type === "subst") {
                    subbedOffIds.add(e.player.id); // 'player' is the one LEAVING the pitch
                }
            });
        }

        // 3. Process & Filter Players
        const allPlayers = [...data.players[0].players, ...data.players[1].players];
        
        // FILTER: Fouls >= 2
        const riskyPlayers = allPlayers.filter(p => {
            return (p.statistics[0].fouls.committed || 0) >= 2;
        }).map(p => {
            return { 
                ...p, 
                confidence: Predictor.calculateConfidence(p, time),
                isSubbed: subbedOffIds.has(p.player.id)
            };
        }).sort((a, b) => b.confidence - a.confidence);

        // 4. Render
        const grid = document.getElementById('playerGrid');
        const empty = document.getElementById('emptyState');
        
        if (riskyPlayers.length === 0) {
            grid.innerHTML = '';
            empty.style.display = 'block';
        } else {
            empty.style.display = 'none';
            grid.innerHTML = riskyPlayers.map(p => this.createPlayerCard(p)).join('');
        }
        
        indicator.innerText = "Live";
    },

    createPlayerCard(p) {
        const stats = p.statistics[0];
        const color = Predictor.getRiskColor(p.confidence);
        const isBooked = stats.cards.yellow > 0;
        const subClass = p.isSubbed ? 'subbed' : '';

        // Badges
        let statusBadge = '';
        if (p.isSubbed) statusBadge = `<span class="sub-badge">SUBBED OFF</span>`;
        else if (isBooked) statusBadge = `<span style="background:yellow; color:black; padding:2px 6px; border-radius:4px; font-weight:bold; font-size:0.7rem;">BOOKED</span>`;
        else statusBadge = `<span style="color:${color}; font-weight:bold;">${p.confidence}% Risk</span>`;

        return `
            <div class="player-card ${subClass}" style="border-left-color: ${p.isSubbed ? '#555' : color}">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <strong>${p.player.name}</strong> ${statusBadge}
                        <div style="font-size:0.8rem; color:#888; margin-top:4px;">
                            ${stats.games.position} | ${p.statistics[0].team.name}
                        </div>
                    </div>
                    <div style="text-align:center;">
                        <div class="stat-big">${stats.fouls.committed}</div>
                        <div class="stat-label">Fouls</div>
                    </div>
                </div>
                
                <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px; display:flex; gap:15px; font-size:0.85rem; color:#aaa;">
                   <span>Tackles: <b style="color:white">${stats.tackles.total || 0}</b></span>
                   <span>Mins: <b style="color:white">${stats.games.minutes || 0}'</b></span>
                </div>
            </div>
        `;
    }
};

App.init();
</script>
</body>
</html>
